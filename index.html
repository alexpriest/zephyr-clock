<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Zephyr's Day Clock</title>

    <!-- Google Font: Nunito - friendly, rounded, readable -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%231a1a2e'/%3E%3Ccircle cx='50' cy='50' r='40' fill='%235ba4d9'/%3E%3Cpath d='M50 50 L50 20' stroke='%23ffd700' stroke-width='4' stroke-linecap='round'/%3E%3Ccircle cx='50' cy='50' r='5' fill='%23fff'/%3E%3Ctext x='50' y='85' text-anchor='middle' font-size='20' fill='%23fff'%3EZ%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%231a1a2e'/%3E%3Ccircle cx='50' cy='50' r='40' fill='%235ba4d9'/%3E%3Cpath d='M50 50 L50 20' stroke='%23ffd700' stroke-width='4' stroke-linecap='round'/%3E%3Ccircle cx='50' cy='50' r='5' fill='%23fff'/%3E%3Ctext x='50' y='85' text-anchor='middle' font-size='20' font-family='sans-serif' font-weight='bold' fill='%23fff'%3EZ%3C/text%3E%3C/svg%3E">

    <!-- Open Graph / Social Sharing -->
    <meta property="og:title" content="Zephyr's Day Clock">
    <meta property="og:description" content="A colorful 24-hour visual clock helping kids understand their daily routine">
    <meta property="og:image" content="https://prjcts.alxprst.co/zephyr-clock/preview.png">
    <meta property="og:url" content="https://prjcts.alxprst.co/zephyr-clock">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Zephyr's Day Clock">
    <meta name="twitter:description" content="A colorful 24-hour visual clock helping kids understand their daily routine">
    <meta name="twitter:image" content="https://prjcts.alxprst.co/zephyr-clock/preview.png">

    <!-- iOS Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Zephyr Clock">

    <!-- Prevent text selection and callouts -->
    <meta name="format-detection" content="telephone=no">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: 'Nunito', 'Comic Sans MS', sans-serif;
            padding: 40px 20px;
            padding-top: max(50px, env(safe-area-inset-top, 50px));
            padding-bottom: max(50px, env(safe-area-inset-bottom, 50px));
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        @media (orientation: landscape) and (min-width: 700px) {
            .container {
                flex-direction: row;
                justify-content: center;
                align-items: center;
                gap: 40px;
            }

            h1 {
                font-size: 1.8rem;
                margin-bottom: 5px;
            }

            .date-display {
                font-size: 1.1rem;
                margin-bottom: 15px;
            }

            .clock-container {
                width: min(50vh, 500px);
                height: min(50vh, 500px);
                flex-shrink: 0;
            }

            .sidebar {
                align-items: center;
            }

            .current-activity {
                margin-top: 0;
                text-align: center;
            }

            .legend {
                margin-top: 0;
                justify-content: center;
                max-width: 350px;
            }
        }

        h1 {
            color: #fff;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .date-display {
            color: rgba(255,255,255,0.9);
            font-size: 1.4rem;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .clock-container {
            position: relative;
            width: min(70vw, 55vh, 500px);
            height: min(70vw, 55vh, 500px);
            aspect-ratio: 1 / 1;
            flex-shrink: 0;
        }

        .clock {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 60px rgba(255,255,255,0.1);
            aspect-ratio: 1 / 1;
        }

        .clock-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            z-index: 20;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        .hand {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(0deg);
            width: 8px;
            height: 38%;
            background: linear-gradient(to top, #fff, #ffd700);
            border-radius: 4px;
            z-index: 15;
            box-shadow: 0 0 15px rgba(255,215,0,0.5);
        }

        .second-hand {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(0deg);
            width: 2px;
            height: 42%;
            background: rgba(255,255,255,0.5);
            border-radius: 1px;
            z-index: 14;
        }

        .confetti {
            position: fixed;
            pointer-events: none;
            z-index: 100;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            opacity: 0;
            animation: confetti-fall 3s ease-out forwards;
        }

        @keyframes confetti-fall {
            0% {
                opacity: 1;
                transform: translateY(0) rotate(0deg) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(400px) rotate(720deg) scale(0.5);
            }
        }

        .current-activity {
            margin-top: 30px;
            padding: 20px 40px;
            border-radius: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: background-color 1s ease, box-shadow 1s ease;
        }

        .current-activity h2 {
            color: #ffd700;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .current-activity p {
            color: #fff;
            font-size: 1.8rem;
        }

        .current-time {
            color: rgba(255,255,255,0.7);
            font-size: 1rem;
            margin-top: 10px;
        }

        .legend {
            margin-top: 25px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px 20px;
            max-width: 600px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fff;
            font-size: 1rem;
            padding: 6px 10px;
            border-radius: 8px;
            transition: background 1s ease, box-shadow 1s ease;
            cursor: pointer;
        }

        .legend-item:hover {
            background: rgba(255,255,255,0.1);
        }

        /* iOS tap optimization */
        .legend-item,
        .clock,
        .day-toggle {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .legend-item.active,
        .legend-item.highlighted {
            background: rgba(255,215,0,0.2);
            box-shadow: 0 0 12px rgba(255,215,0,0.4);
        }

        .legend-item.fading {
            background: rgba(255,215,0,0);
            box-shadow: 0 0 0px rgba(255,215,0,0);
        }

        .legend-color {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .day-toggles {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .day-toggle {
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-family: inherit;
        }

        .day-toggle:hover {
            background: rgba(255,255,255,0.2);
        }

        .day-toggle.active {
            background: rgba(255,215,0,0.3);
            color: #fff;
            box-shadow: 0 0 8px rgba(255,215,0,0.3);
        }

        .day-toggle.today {
            border: 2px solid rgba(255,215,0,0.5);
        }

        svg {
            width: 100%;
            height: 100%;
        }

        .clock-segment {
            cursor: pointer;
            transition: fill 0.3s ease, filter 0.3s ease;
        }

        .clock-segment.glowing {
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8)) drop-shadow(0 0 12px rgba(255, 215, 0, 0.5));
        }
    </style>
</head>
<body>
    <h1>Zephyr's Day Clock</h1>
    <div class="date-display" id="date-display"></div>

    <div class="container">
        <div class="clock-container">
            <div class="clock">
                <svg viewBox="0 0 240 240" id="clock-svg">
                    <!-- Segments will be drawn here -->
                </svg>
                <div class="second-hand" id="second-hand"></div>
                <div class="hand" id="hand"></div>
                <div class="clock-center"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="current-activity">
                <h2>Right Now:</h2>
                <p id="activity-text">Loading...</p>
                <div class="current-time" id="current-time"></div>
            </div>

            <div class="legend" id="legend"></div>
        </div>
    </div>

    <div class="day-toggles" id="day-toggles"></div>

    <script>
        function createConfetti() {
            const container = document.createElement('div');
            container.className = 'confetti';
            document.body.appendChild(container);

            const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dfe6e9', '#a29bfe'];

            for (let i = 0; i < 30; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.left = Math.random() * 100 + 'vw';
                piece.style.top = Math.random() * 30 + 'vh';
                piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                piece.style.animationDelay = Math.random() * 0.5 + 's';
                piece.style.animationDuration = (2 + Math.random() * 2) + 's';
                container.appendChild(piece);
            }

            setTimeout(() => container.remove(), 4000);
        }

        function celebrateTransition() {
            createConfetti();
        }

        // Base schedule (Tues, Thurs, Fri)
        const baseScheduleForDrawing = [
            { start: 20.25, end: 31, label: "Sleep", color: "#1e3a5f", emoji: "ðŸ˜´" },
            { start: 7, end: 8, label: "Wake Up, Breakfast, Get Ready", color: "#4a7c59", emoji: "ðŸŒ…" },
            { start: 8, end: 8.5, label: "Go to School", color: "#e8a838", emoji: "ðŸš—" },
            { start: 8.5, end: 17, label: "School", color: "#5ba4d9", emoji: "ðŸ«" },
            { start: 17, end: 18, label: "Play", color: "#7eb5e0", emoji: "ðŸŽ¨" },
            { start: 18, end: 19, label: "Dinner & Walk", color: "#e88a5a", emoji: "ðŸ½ï¸" },
            { start: 19, end: 19.5, label: "Bath & Jammies", color: "#c97b84", emoji: "ðŸ›" },
            { start: 19.5, end: 20, label: "Stories & Candlelight", color: "#8b6aa8", emoji: "ðŸ“š" },
            { start: 20, end: 20.25, label: "Songs", color: "#5d4e7a", emoji: "ðŸŽµ" },
        ];

        // Jiu-Jitsu schedule (Mon, Wed) - adds jiu-jitsu from 4-5pm
        const jiuJitsuScheduleForDrawing = [
            { start: 20.25, end: 31, label: "Sleep", color: "#1e3a5f", emoji: "ðŸ˜´" },
            { start: 7, end: 8, label: "Wake Up, Breakfast, Get Ready", color: "#4a7c59", emoji: "ðŸŒ…" },
            { start: 8, end: 8.5, label: "Go to School", color: "#e8a838", emoji: "ðŸš—" },
            { start: 8.5, end: 16, label: "School", color: "#5ba4d9", emoji: "ðŸ«" },
            { start: 16, end: 17, label: "Jiu-Jitsu", color: "#d35400", emoji: "ðŸ¥‹" },
            { start: 17, end: 18, label: "Play", color: "#7eb5e0", emoji: "ðŸŽ¨" },
            { start: 18, end: 19, label: "Dinner & Walk", color: "#e88a5a", emoji: "ðŸ½ï¸" },
            { start: 19, end: 19.5, label: "Bath & Jammies", color: "#c97b84", emoji: "ðŸ›" },
            { start: 19.5, end: 20, label: "Stories & Candlelight", color: "#8b6aa8", emoji: "ðŸ“š" },
            { start: 20, end: 20.25, label: "Songs", color: "#5d4e7a", emoji: "ðŸŽµ" },
        ];

        // Weekend schedule (Sat, Sun)
        const weekendScheduleForDrawing = [
            { start: 20.25, end: 31, label: "Sleep", color: "#1e3a5f", emoji: "ðŸ˜´" },
            { start: 7, end: 8, label: "Wake Up, Breakfast, Get Ready", color: "#4a7c59", emoji: "ðŸŒ…" },
            { start: 8, end: 13, label: "Family Time", color: "#5ba4d9", emoji: "ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦" },
            { start: 13, end: 15, label: "Nap", color: "#9b88b4", emoji: "ðŸ’¤" },
            { start: 15, end: 18, label: "Family Time", color: "#5ba4d9", emoji: "ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦" },
            { start: 18, end: 19, label: "Dinner & Walk", color: "#e88a5a", emoji: "ðŸ½ï¸" },
            { start: 19, end: 19.5, label: "Bath & Jammies", color: "#c97b84", emoji: "ðŸ›" },
            { start: 19.5, end: 20, label: "Stories & Candlelight", color: "#8b6aa8", emoji: "ðŸ“š" },
            { start: 20, end: 20.25, label: "Songs", color: "#5d4e7a", emoji: "ðŸŽµ" },
        ];

        const baseSchedule = [
            { start: 0, end: 7, label: "Sleep", color: "#1e3a5f", emoji: "ðŸ˜´" },
            { start: 7, end: 8, label: "Wake Up, Breakfast, Get Ready", color: "#4a7c59", emoji: "ðŸŒ…" },
            { start: 8, end: 8.5, label: "Go to School", color: "#e8a838", emoji: "ðŸš—" },
            { start: 8.5, end: 17, label: "School", color: "#5ba4d9", emoji: "ðŸ«" },
            { start: 17, end: 18, label: "Play", color: "#7eb5e0", emoji: "ðŸŽ¨" },
            { start: 18, end: 19, label: "Dinner & Walk", color: "#e88a5a", emoji: "ðŸ½ï¸" },
            { start: 19, end: 19.5, label: "Bath & Jammies", color: "#c97b84", emoji: "ðŸ›" },
            { start: 19.5, end: 20, label: "Stories & Candlelight", color: "#8b6aa8", emoji: "ðŸ“š" },
            { start: 20, end: 20.25, label: "Songs", color: "#5d4e7a", emoji: "ðŸŽµ" },
            { start: 20.25, end: 24, label: "Sleep", color: "#1e3a5f", emoji: "ðŸ˜´" },
        ];

        const jiuJitsuSchedule = [
            { start: 0, end: 7, label: "Sleep", color: "#1e3a5f", emoji: "ðŸ˜´" },
            { start: 7, end: 8, label: "Wake Up, Breakfast, Get Ready", color: "#4a7c59", emoji: "ðŸŒ…" },
            { start: 8, end: 8.5, label: "Go to School", color: "#e8a838", emoji: "ðŸš—" },
            { start: 8.5, end: 16, label: "School", color: "#5ba4d9", emoji: "ðŸ«" },
            { start: 16, end: 17, label: "Jiu-Jitsu", color: "#d35400", emoji: "ðŸ¥‹" },
            { start: 17, end: 18, label: "Play", color: "#7eb5e0", emoji: "ðŸŽ¨" },
            { start: 18, end: 19, label: "Dinner & Walk", color: "#e88a5a", emoji: "ðŸ½ï¸" },
            { start: 19, end: 19.5, label: "Bath & Jammies", color: "#c97b84", emoji: "ðŸ›" },
            { start: 19.5, end: 20, label: "Stories & Candlelight", color: "#8b6aa8", emoji: "ðŸ“š" },
            { start: 20, end: 20.25, label: "Songs", color: "#5d4e7a", emoji: "ðŸŽµ" },
            { start: 20.25, end: 24, label: "Sleep", color: "#1e3a5f", emoji: "ðŸ˜´" },
        ];

        const weekendSchedule = [
            { start: 0, end: 7, label: "Sleep", color: "#1e3a5f", emoji: "ðŸ˜´" },
            { start: 7, end: 8, label: "Wake Up, Breakfast, Get Ready", color: "#4a7c59", emoji: "ðŸŒ…" },
            { start: 8, end: 13, label: "Family Time", color: "#5ba4d9", emoji: "ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦" },
            { start: 13, end: 15, label: "Nap", color: "#9b88b4", emoji: "ðŸ’¤" },
            { start: 15, end: 18, label: "Family Time", color: "#5ba4d9", emoji: "ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦" },
            { start: 18, end: 19, label: "Dinner & Walk", color: "#e88a5a", emoji: "ðŸ½ï¸" },
            { start: 19, end: 19.5, label: "Bath & Jammies", color: "#c97b84", emoji: "ðŸ›" },
            { start: 19.5, end: 20, label: "Stories & Candlelight", color: "#8b6aa8", emoji: "ðŸ“š" },
            { start: 20, end: 20.25, label: "Songs", color: "#5d4e7a", emoji: "ðŸŽµ" },
            { start: 20.25, end: 24, label: "Sleep", color: "#1e3a5f", emoji: "ðŸ˜´" },
        ];

        // Track which day we're viewing (null = today)
        let viewingDay = null;

        function getTodayDayOfWeek() {
            return new Date().getDay(); // 0 = Sunday, 1 = Monday, etc.
        }

        function getViewingDay() {
            return viewingDay !== null ? viewingDay : getTodayDayOfWeek();
        }

        function isWeekend() {
            const day = getViewingDay();
            return day === 0 || day === 6; // Sunday or Saturday
        }

        function isJiuJitsuDay() {
            const day = getViewingDay();
            return day === 1 || day === 3; // Monday or Wednesday
        }

        function getScheduleForDrawing() {
            if (isWeekend()) return weekendScheduleForDrawing;
            if (isJiuJitsuDay()) return jiuJitsuScheduleForDrawing;
            return baseScheduleForDrawing;
        }

        function getSchedule() {
            if (isWeekend()) return weekendSchedule;
            if (isJiuJitsuDay()) return jiuJitsuSchedule;
            return baseSchedule;
        }

        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const fullDayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        function buildDayToggles() {
            const container = document.getElementById('day-toggles');
            container.innerHTML = '';
            const today = getTodayDayOfWeek();
            const viewing = getViewingDay();

            dayNames.forEach((name, index) => {
                const btn = document.createElement('button');
                btn.className = 'day-toggle';
                btn.textContent = name;

                if (index === today) {
                    btn.classList.add('today');
                }
                if (index === viewing) {
                    btn.classList.add('active');
                }

                btn.addEventListener('click', () => {
                    viewingDay = index === today ? null : index;
                    rebuildForDay();
                });

                container.appendChild(btn);
            });
        }

        function rebuildForDay() {
            suppressNextTransition = true; // Don't fire confetti when switching days
            updateDateDisplay();
            document.getElementById('clock-svg').innerHTML = '';
            drawClock();
            buildLegend();
            buildDayToggles();
        }

        function hourToAngle(hour) {
            // 12am (midnight) at top = 0 degrees, goes clockwise
            return (hour / 24) * 360;
        }

        function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return {
                x: centerX + (radius * Math.cos(angleInRadians)),
                y: centerY + (radius * Math.sin(angleInRadians))
            };
        }

        function describeArc(x, y, radius, startAngle, endAngle) {
            const start = polarToCartesian(x, y, radius, startAngle);
            const end = polarToCartesian(x, y, radius, endAngle);
            const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
            return [
                "M", x, y,
                "L", start.x, start.y,
                "A", radius, radius, 0, largeArcFlag, 1, end.x, end.y,
                "Z"
            ].join(" ");
        }

        function handleSegmentTap(label) {
            highlightSection(label);
        }

        function drawClock() {
            const svg = document.getElementById('clock-svg');
            const centerX = 120;
            const centerY = 120;
            const radius = 100;

            // Draw schedule segments using the drawing schedule (sleep as one piece)
            const scheduleForDrawing = getScheduleForDrawing();
            scheduleForDrawing.forEach(item => {
                // Handle wrap-around for sleep (end > 24 means it wraps)
                const startAngle = hourToAngle(item.start % 24);
                const endAngle = hourToAngle(item.end % 24);

                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");

                // For sleep segment that wraps around midnight
                if (item.end > 24) {
                    // Draw as two arcs but in one path (or use a large arc)
                    const midnightAngle = 0;
                    const d1 = describeArc(centerX, centerY, radius, startAngle, 360);
                    const d2 = describeArc(centerX, centerY, radius, 0, endAngle);

                    // Create the combined sleep segment
                    path.setAttribute("d", describeArc(centerX, centerY, radius, startAngle, 360 + endAngle));
                } else {
                    path.setAttribute("d", describeArc(centerX, centerY, radius, startAngle, endAngle));
                }

                path.setAttribute("fill", item.color);
                path.setAttribute("class", "clock-segment");
                path.setAttribute("data-label", item.label);
                path.style.cursor = 'pointer';

                svg.appendChild(path);
            });

            // Draw divider lines (skip sleep - it's one continuous block)
            scheduleForDrawing.forEach((item, index) => {
                if (item.label === "Sleep") return; // No line for sleep

                const startAngle = hourToAngle(item.start);
                const outerPos = polarToCartesian(centerX, centerY, radius, startAngle);

                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", centerX);
                line.setAttribute("y1", centerY);
                line.setAttribute("x2", outerPos.x);
                line.setAttribute("y2", outerPos.y);
                line.setAttribute("stroke", "rgba(255,255,255,0.2)");
                line.setAttribute("stroke-width", "1");
                svg.appendChild(line);
            });

            // Draw hour markers and numbers
            for (let hour = 0; hour < 24; hour += 3) {
                const angle = hourToAngle(hour);
                const innerPos = polarToCartesian(centerX, centerY, radius * 0.85, angle);
                const outerPos = polarToCartesian(centerX, centerY, radius * 0.95, angle);

                // Tick mark
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", innerPos.x);
                line.setAttribute("y1", innerPos.y);
                line.setAttribute("x2", outerPos.x);
                line.setAttribute("y2", outerPos.y);
                line.setAttribute("stroke", "rgba(255,255,255,0.6)");
                line.setAttribute("stroke-width", "2");
                svg.appendChild(line);

                // Hour number
                const textPos = polarToCartesian(centerX, centerY, radius * 0.73, angle);
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", textPos.x);
                text.setAttribute("y", textPos.y);
                text.setAttribute("text-anchor", "middle");
                text.setAttribute("dominant-baseline", "middle");
                text.setAttribute("fill", "rgba(255,255,255,0.9)");
                text.setAttribute("font-size", "10");
                text.setAttribute("font-weight", "bold");
                text.textContent = hour === 0 ? "12a" : hour === 12 ? "12p" : hour < 12 ? `${hour}a` : `${hour-12}p`;
                svg.appendChild(text);
            }
        }

        function getCurrentActivity(hour) {
            const schedule = getSchedule();
            for (const item of schedule) {
                if (hour >= item.start && hour < item.end) {
                    return item;
                }
            }
            return schedule[0];
        }

        let lastActivityLabel = null;
        let suppressNextTransition = false;

        function updateClock() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            const currentHour = hours + minutes / 60 + seconds / 3600;
            const hourAngle = hourToAngle(currentHour);

            // Update hour hand
            const hand = document.getElementById('hand');
            hand.style.transform = `translateX(-50%) rotate(${hourAngle}deg)`;

            // Update second hand (full rotation every 60 seconds)
            const secondAngle = (seconds / 60) * 360;
            const secondHand = document.getElementById('second-hand');
            secondHand.style.transform = `translateX(-50%) rotate(${secondAngle}deg)`;

            const activity = getCurrentActivity(currentHour);

            // Check for activity transition (only if not suppressed by day switch)
            if (lastActivityLabel !== null && lastActivityLabel !== activity.label && !suppressNextTransition) {
                celebrateTransition();
            }
            lastActivityLabel = activity.label;
            suppressNextTransition = false;

            document.getElementById('activity-text').textContent = activity.emoji + " " + activity.label;
            updateLegendHighlight(activity.label);

            // Tint the "Right Now" box with the activity color
            const activityBox = document.querySelector('.current-activity');
            activityBox.style.backgroundColor = hexToRgba(activity.color, 0.3);
            activityBox.style.boxShadow = `0 0 20px ${hexToRgba(activity.color, 0.3)}`;

            const timeStr = now.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            document.getElementById('current-time').textContent = timeStr;
        }

        const baseLegendItems = [
            { label: "Sleep", color: "#1e3a5f", emoji: "ðŸ˜´" },
            { label: "Wake Up, Breakfast, Get Ready", color: "#4a7c59", emoji: "ðŸŒ…" },
            { label: "Go to School", color: "#e8a838", emoji: "ðŸš—" },
            { label: "School", color: "#5ba4d9", emoji: "ðŸ«" },
            { label: "Play", color: "#7eb5e0", emoji: "ðŸŽ¨" },
            { label: "Dinner & Walk", color: "#e88a5a", emoji: "ðŸ½ï¸" },
            { label: "Bath & Jammies", color: "#c97b84", emoji: "ðŸ›" },
            { label: "Stories & Candlelight", color: "#8b6aa8", emoji: "ðŸ“š" },
            { label: "Songs", color: "#5d4e7a", emoji: "ðŸŽµ" },
        ];

        const jiuJitsuLegendItems = [
            { label: "Sleep", color: "#1e3a5f", emoji: "ðŸ˜´" },
            { label: "Wake Up, Breakfast, Get Ready", color: "#4a7c59", emoji: "ðŸŒ…" },
            { label: "Go to School", color: "#e8a838", emoji: "ðŸš—" },
            { label: "School", color: "#5ba4d9", emoji: "ðŸ«" },
            { label: "Jiu-Jitsu", color: "#d35400", emoji: "ðŸ¥‹" },
            { label: "Play", color: "#7eb5e0", emoji: "ðŸŽ¨" },
            { label: "Dinner & Walk", color: "#e88a5a", emoji: "ðŸ½ï¸" },
            { label: "Bath & Jammies", color: "#c97b84", emoji: "ðŸ›" },
            { label: "Stories & Candlelight", color: "#8b6aa8", emoji: "ðŸ“š" },
            { label: "Songs", color: "#5d4e7a", emoji: "ðŸŽµ" },
        ];

        const weekendLegendItems = [
            { label: "Sleep", color: "#1e3a5f", emoji: "ðŸ˜´" },
            { label: "Wake Up, Breakfast, Get Ready", color: "#4a7c59", emoji: "ðŸŒ…" },
            { label: "Family Time", color: "#5ba4d9", emoji: "ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦" },
            { label: "Nap", color: "#9b88b4", emoji: "ðŸ’¤" },
            { label: "Dinner & Walk", color: "#e88a5a", emoji: "ðŸ½ï¸" },
            { label: "Bath & Jammies", color: "#c97b84", emoji: "ðŸ›" },
            { label: "Stories & Candlelight", color: "#8b6aa8", emoji: "ðŸ“š" },
            { label: "Songs", color: "#5d4e7a", emoji: "ðŸŽµ" },
        ];

        function getLegendItems() {
            if (isWeekend()) return weekendLegendItems;
            if (isJiuJitsuDay()) return jiuJitsuLegendItems;
            return baseLegendItems;
        }

        function updateDateDisplay() {
            const now = new Date();
            const viewing = getViewingDay();
            const today = getTodayDayOfWeek();

            if (viewingDay === null) {
                // Showing today
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const dateStr = now.toLocaleDateString('en-US', options);
                document.getElementById('date-display').textContent = dateStr;
            } else {
                // Showing a different day
                document.getElementById('date-display').textContent = fullDayNames[viewing] + ' Schedule';
            }
        }

        function handleLegendTap(label) {
            highlightSection(label);
        }

        // Debounced tap handler for legend items
        let lastLegendTapTime = 0;
        function debouncedLegendTap(label) {
            const now = Date.now();
            if (now - lastLegendTapTime < 300) return;
            lastLegendTapTime = now;
            handleLegendTap(label);
        }

        function buildLegend() {
            const legend = document.getElementById('legend');
            legend.innerHTML = ''; // Clear existing

            const legendItems = getLegendItems();
            legendItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'legend-item';
                div.dataset.label = item.label;
                div.innerHTML = `
                    <div class="legend-color" style="background: ${item.color}">${item.emoji}</div>
                    <span>${item.label}</span>
                `;

                // Use pointer events if available (iOS Safari 13+)
                if (window.PointerEvent) {
                    div.addEventListener('pointerup', (e) => {
                        if (e.pointerType === 'touch' || e.pointerType === 'mouse') {
                            debouncedLegendTap(item.label);
                        }
                    });
                } else {
                    // Fallback: touchend with click backup
                    div.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        debouncedLegendTap(item.label);
                    });
                    div.addEventListener('click', () => {
                        debouncedLegendTap(item.label);
                    });
                }
                legend.appendChild(div);
            });
        }

        let userHighlight = null;
        let userHighlightTimeout = null;

        function updateLegendHighlight(currentLabel) {
            document.querySelectorAll('.legend-item').forEach(item => {
                // Active = current time, Highlighted = user tapped
                if (item.dataset.label === currentLabel) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Helper to lighten a hex color
        function lightenColor(hex, percent) {
            const num = parseInt(hex.replace('#', ''), 16);
            const r = Math.min(255, Math.floor((num >> 16) + (255 - (num >> 16)) * percent));
            const g = Math.min(255, Math.floor(((num >> 8) & 0x00FF) + (255 - ((num >> 8) & 0x00FF)) * percent));
            const b = Math.min(255, Math.floor((num & 0x0000FF) + (255 - (num & 0x0000FF)) * percent));
            return '#' + (0x1000000 + r * 0x10000 + g * 0x100 + b).toString(16).slice(1);
        }

        // Helper to convert hex to rgba
        function hexToRgba(hex, alpha) {
            const num = parseInt(hex.replace('#', ''), 16);
            const r = (num >> 16) & 255;
            const g = (num >> 8) & 255;
            const b = num & 255;
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function highlightSection(label) {
            // Clear any existing timeout
            if (userHighlightTimeout) {
                clearTimeout(userHighlightTimeout);
            }

            // First, restore any previously highlighted segments
            clearSegmentHighlights();

            userHighlight = label;

            // Highlight legend item
            document.querySelectorAll('.legend-item').forEach(item => {
                if (item.dataset.label === label) {
                    item.classList.add('highlighted');
                } else {
                    item.classList.remove('highlighted');
                }
            });

            // Highlight clock segment using style.fill + glow effect
            document.querySelectorAll('.clock-segment').forEach(seg => {
                const segLabel = seg.getAttribute('data-label');
                if (segLabel === label) {
                    const originalColor = seg.getAttribute('data-original-color') || seg.getAttribute('fill');
                    seg.setAttribute('data-original-color', originalColor);
                    seg.style.fill = lightenColor(originalColor, 0.4);
                    seg.classList.add('glowing');
                }
            });

            // Start fade out after 1.5 seconds
            userHighlightTimeout = setTimeout(() => {
                fadeOutHighlight();
            }, 1500);
        }

        function clearSegmentHighlights() {
            document.querySelectorAll('.clock-segment').forEach(seg => {
                const originalColor = seg.getAttribute('data-original-color');
                if (originalColor) {
                    seg.style.fill = originalColor;
                }
                seg.classList.remove('glowing');
            });
        }

        function fadeOutHighlight() {
            // Add fading class to legend items
            document.querySelectorAll('.legend-item.highlighted').forEach(item => {
                item.classList.add('fading');
            });

            // Restore segment colors
            clearSegmentHighlights();

            // Remove legend classes after fade completes
            setTimeout(() => {
                clearHighlight();
            }, 1000);
        }

        function clearHighlight() {
            userHighlight = null;
            document.querySelectorAll('.legend-item').forEach(item => {
                item.classList.remove('highlighted', 'fading');
            });
            clearSegmentHighlights();
        }

        // Handle taps on the clock - iOS-optimized approach
        function setupClockTapHandler() {
            const clockContainer = document.querySelector('.clock');
            let lastTapTime = 0;

            function processClockTap(clientX, clientY) {
                // Debounce to prevent double-firing from touch + click
                const now = Date.now();
                if (now - lastTapTime < 300) return;
                lastTapTime = now;

                // Get tap coordinates
                const rect = clockContainer.getBoundingClientRect();

                // Convert to position relative to clock center (0-1 range)
                const relX = (clientX - rect.left) / rect.width - 0.5;
                const relY = (clientY - rect.top) / rect.height - 0.5;
                const distance = Math.sqrt(relX * relX + relY * relY);

                // Only respond if within the clock face (radius ~0.42 accounting for SVG viewBox)
                if (distance > 0.45) return;

                // Calculate angle (0 = top, clockwise)
                let angle = Math.atan2(relX, -relY) * (180 / Math.PI);
                if (angle < 0) angle += 360;

                // Convert angle to hour
                const hour = (angle / 360) * 24;

                // Find which activity this hour falls into
                const activity = getCurrentActivity(hour);
                if (activity) {
                    handleSegmentTap(activity.label);
                }
            }

            // Use pointer events if available (modern iOS Safari supports these)
            if (window.PointerEvent) {
                clockContainer.addEventListener('pointerup', (e) => {
                    if (e.pointerType === 'touch' || e.pointerType === 'mouse') {
                        processClockTap(e.clientX, e.clientY);
                    }
                });
            } else {
                // Fallback for older browsers
                clockContainer.addEventListener('touchend', (e) => {
                    const touch = e.changedTouches[0];
                    if (touch) {
                        e.preventDefault();
                        processClockTap(touch.clientX, touch.clientY);
                    }
                });
                clockContainer.addEventListener('click', (e) => {
                    processClockTap(e.clientX, e.clientY);
                });
            }
        }

        // Initialize
        updateDateDisplay();
        drawClock();
        buildLegend();
        buildDayToggles();
        setupClockTapHandler();
        updateClock();
        setInterval(updateClock, 1000);

        // Check for day change every minute and rebuild if needed
        let currentDay = getTodayDayOfWeek();
        setInterval(() => {
            const newDay = getTodayDayOfWeek();
            if (newDay !== currentDay) {
                currentDay = newDay;
                // If viewing today, rebuild
                if (viewingDay === null) {
                    rebuildForDay();
                } else {
                    // Just update the toggle highlights
                    buildDayToggles();
                }
            }
        }, 60000);
    </script>
</body>
</html>
